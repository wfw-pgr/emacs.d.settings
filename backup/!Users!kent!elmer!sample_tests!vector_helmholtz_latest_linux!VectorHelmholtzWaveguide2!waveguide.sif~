
! ========================================================= !
! ===  waveguide simulation                             === !
! ========================================================= !

! ------------------------------------------------- !
! --- [1] Global Simulation Settings            --- !
! ------------------------------------------------- !

Check Keywords "Warn"

Header
  Mesh DB "." "inner"
  Include Path ""
  Results Directory ""
End

Simulation
  Coordinate System           = String "Cartesian"
  Coordinate Mapping(3)       = 1 2 3

  Simulation Type             = Steady
  Steady State Max Iterations = Integer 1
  Output Intervals            = Integer 1
  Timestepping Method         = BDF
  BDF Order                   = Integer 1
  
  Solver Input File           = "waveguide.sif"
  Output File                 = "waveguide.dat"
  Post File                   = "vectorhelmholtz.vtu"
End

Constants
  ! Do NOT write down - permeability - an error somehow occurs...!!!
  ! Permeability of Vacuum      = 1.2566e-06
  ! Permittivity of Vacuum      = 8.8542e-12
End

! ------------------------------------------------- !
! --- [2] Body & Material Settings              --- !
! ------------------------------------------------- !

Body 1
  Target Bodies(1)       = 301
  Name                   = "wavepath"

  Equation               = 1
  Material               = 1
  Initial Condition      = 1
End

Material 1
  Name                   = "Air"
  Electric Conductivity  = 0.0
  Relative Permittivity  = 1.0
  Relative Permeability  = 1.0
End


! ------------------------------------------------- !
! --- [3] Equation & Solver Settings            --- !
! ------------------------------------------------- !

$ freq  = 2.5e9
$ wg_a  = 0.10
$ wg_b  = 0.05
$ wg_L  = 0.20
$ wAmp  = 1.0

$ mmode = 1
$ nmode = 0
$ epsil = 8.854e-12
$ mu    = 4.0*pi*10^-7
$ c0    = 1.0 / sqrt( epsil * mu )
$ omega = 2.0 * pi * freq
$ k0    = omega / c0
$ kx    = mmode * pi / wg_a
$ ky    = nmode * pi / wg_b
$ kc    = sqrt( kx^2 + ky^2 )
$ beta0 = sqrt( k0^2 - kc^2 )
$ Acoef = omega * mu * kx * wAmp / kc^2
$ sigma = 5.e3
$ Zp_m  = sqrt( 0.5 * mu * omega / sigma )
$ alp_m = omega * mu / Zp_m
! alpha_for_metal = -i / ( 1 - i ) * alp_m = ( 1-i ) / 2 * alp_m ...> set this value as B.C.


! $ wg_a = 0.10
! $ wg_b = 0.05
! $ wb_L = 0.20
! $ kx   = 
! $ beta0=41.9332032192090
! $ k0=52.3961255469564
! $ kc=31.4159265358979 
! $ w=2*pi*(2.0e9)
! $ mu0=4.00e-7 * pi
! $ eps=8.85e-12

! Initial Condition 1
!   ! Pre = Variable coordinate
!   ! Real MATC "rand(1)"
!   Eref_re 2 = Variable coordinate 1, coordinate 3
!       Real MATC "sin(kx*tx(0))*( sin( beta0*tx(1) ) - sin( -beta0*tx(1)+2.0*beta0*wg_L) )"
!   ! Real MATC "-1.66782047593233*sin(kx*tx(0))*( sin( beta0*tx(1) ) - sin( -beta0*tx(1)+2.0*beta0*wg_L) )"
! End

! Material 1
!   Relative Permittivity = Real 1
! End

Equation 1
  Active Solvers(2) = 1 2
  Angular Frequency = Real $omega
End


Solver 1
  Equation = "VectorHelmholtz"
  Variable = E[E re:1 E im:1]
  Use Piola Transform = Logical False
  Optimize Bandwidth = True
  Linear System Symmetric = False
  Procedure = "VectorHelmholtz" "VectorHelmholtzSolver"

  Linear System Scaling = True

  !Linear System Use Hypre = Logical True
  !Linear System Use Trilinos = Logical True
  !Linear System Use Mumps = Logical True

  Linear System Solver = String "Iterative"
  !Linear System Solver = String "Direct"
  Linear System Iterative Method = String "gmres" !bicgstabl"
  BiCGstabl polynomial degree = Integer 4
  
  Linear System Preconditioning Damp Coefficient = Real 0.0
  Linear System Preconditioning Damp Coefficient im = Real 1
  !Linear System Preconditioning = String "boomerAMG"
  !Linear System Preconditioning = String "parasails"
  Linear System Preconditioning = String "vanka"
  !Linear System Preconditioning = String "None"
  !Linear System Preconditioning = String "diagonal"
  !Linear System Preconditioning = String "ILU1"
  Linear System ILUT Tolerance = Real 3e-3
  Linear System Max Iterations = Integer 4000
  Linear System Convergence Tolerance = 1.0e-10

  linear system abort not converged = false

  Steady State Convergence Tolerance = 1e-09
  Linear System Residual Output = 10
End

Solver 2
  Equation = "calcfields"

  Use Piola Transform = Logical True
  Optimize Bandwidth = False
  Procedure = "VectorHelmholtz" "VectorHelmholtzCalcFields"
  Linear System Symmetric = False

  Calculate Elemental Fields = Logical False
  
  Calculate Magnetic Field Strength = Logical False
  Calculate Magnetic Flux Density = Logical False
  Calculate Poynting vector = Logical False
  Calculate Div of Poynting Vector = Logical False
  Calculate Electric field = Logical True
  Calculate Energy Functional = Logical True

  Steady State Convergence Tolerance = 1
  Linear System Solver = "Iterative"
  Linear System Preconditioning = None
  Linear System Residual Output = 10
  Linear System Max Iterations = 5000
  Linear System Iterative Method = CG
  Linear System Convergence Tolerance = 1.0e-9
End

! Solver 3
!   Exec Solver = never
!   Equation = "SaveScalars"
!   Procedure = "SaveData" "SaveScalars"
!   FileName = "scalar_values.dat"
! End

Boundary Condition 1
  Target Boundaries(1) = 201 ! 5 !1
  !E re {e} 2 = Variable Coordinate 1
  !Real MATC "10*tx"

  Electric Robin Coefficient im = Real $ beta0
  !E re {e} 2 = Real 1

  Magnetic Boundary Load 2 = Variable Coordinate 1
    Real MATC "-2.0*beta0*k0/kc*sin(kx*tx)"
  !Real MATC "-139.87*sin(pi*tx/100e-3)"
  !Real MATC "-1.1131e8*sin(pi*tx/100e-3)"
  !Real MATC "-2/mu0*beta0*k0/kc*sin(pi*tx/100e-3)"
End

Boundary Condition 2
  Target Boundaries(2) = 202 203 ! 1 2 3 4 6 !2 3 4 5 6

  E re {e} = Real 0
  E im {e} = Real 0
  E re {f} = Real 0
  E im {f} = Real 0

  ! Electric Robin Coefficient = Real $ -474315.9900340191 
  ! Electric Robin Coefficient im = Real $ 474315.9900340191  
End

! Solver 1 :: Reference Norm = 6.36557591E-03
! Solver 1 :: Reference Norm Tolerance = 1.0E-6
! Solver 2 :: Reference Norm = 2.17002474E-05
! Solver 2 :: Reference Norm Tolerance = 1.0E-4


! Header
! ! Mesh DB "." "shoebox_hexas"
! Mesh DB "." "inner"
! End

! Simulation
!   ! Max Output Level = 12

!   Coordinate System = "Cartesian"
!   Simulation Type   = Steady
!   Steady State Max Iterations = 1

!   Post File = vectorhelmholtz.vtu
!   ! Output Intervals(1) = 1
! End

! Constants
! End


! Body 1
!   Target Bodies(1) = 301
!   Equation = 1
!   Material = 1
!   ! Initial Condition = 1
! End

! wg_a, wg_b, wg_L = 0.1, 0.05, 0.2
! kc    = kx = mmode * pi / wg_a = 1 * 3.1415... / 0.1 = 31.41592...
! omega = 2.0 * 3.141592... * 2.5e9 = 15707963267.948965
! k0    = omega / c0 = 52.3948

