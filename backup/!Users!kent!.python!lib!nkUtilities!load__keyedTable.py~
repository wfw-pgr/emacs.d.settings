import re, sys


# ========================================================= #
# ===  Load Tabled with key from File                   === #
# ========================================================= #
def load__keyedTable( inpFile=None, returnType="dict-dict", comment="#" ):
    
    # ------------------------------------------------- #
    # --- [1] Arguments                             --- #
    # ------------------------------------------------- #
    if ( inpFile is None ):
        sys.exit(" [load__keyedTable.py] inpFile == ??? [ERROR]" )
    
    # ------------------------------------------------- #
    # --- [2] Data Load                             --- #
    # ------------------------------------------------- #
    with open( inpFile ) as f:
        lines = f.readlines()

    # ------------------------------------------------- #
    # --- [3] read header                           --- #
    # ------------------------------------------------- #
    irows   = -1
    names   = [""]
    pattern = "#\s*<names>\s*(.*?)#(.*)"
    for ik,line in enumerate( lines ):
        # -- empty line skip          -- #
        if ( len( line.strip() ) == 0 ):
            continue
        # -- header mark              -- #
        ret     = re.match( pattern, line )
        if ( ret is None ):
            continue
        else:
            names = ( ( ret.group(1) ).strip() ).split()
            irows = ik
            break
        
    if ( irows == -1 ):
        irows = 0
        for ik,line in enumerate( lines ):
            # -- empty line skip          -- #
            if ( len( line.strip() ) == 0 ):
                continue
            # -- skip comment line        -- #
            if ( line.strip()[0] == "#"   ):
                continue
            # -- search max column number -- #
            length = len( ( line.strip() ).split() )
            if ( irows < length ):
                irows = length
        names = [ "data{0:03}".format( ik+1 ) for ik in irows ]
        
    else:
        if ( (irows+1) <= len( lines ) ):
            line = lines[(irows+1):]
        else:
            print( "[load__keyedTable.py] names is {0}".format( "".join( names ) ) )
            print( "[load__keyedTable.py] but empty table.... [ERROR]" )
            sys.exit()
        
    nWords = len( names )
            
    # ------------------------------------------------- #
    # --- [4] generate Dictionary                   --- #
    # ------------------------------------------------- #
    vdict = {}
    keys  = []
    for line in lines:

        # -- empty line skip          -- #
        if ( len( line.strip() ) == 0 ):
            continue
        # -- value until comment mark -- #
        pattern = "(.*?)#(.*)"
        ret     = re.match( pattern, line )
        if   ( ret is None ):
            continue
        else:
            line  = ( ret.group(1) ).strip()
            words = line.split()
            if ( len(words) == nWords ):
                try:
                    key = str( words[0] )
                except:
                    key = "key{0:03}".format( len(keys)+1 )
                vdict[key] = { names:word for word in word }
                keys      += [ key ]
            else:
                print( "[load__keyedTable.py] incompatible line... " )
                print( "[load__keyedTable.py] line  == {0}".format( " ".join( words ) ) )
                print( "[load__keyedTable.py] names == {0}".format( " ".join( names ) ) )
                sys.exit()

    # ------------------------------------------------- #
    # --- [4] return                                --- #
    # ------------------------------------------------- #
    if ( returnKeys is True ):
        return( keys  )
    else:
        return( vdict )




# ========================================================= #
# ===   実行部                                          === #
# ========================================================= #

if ( __name__=="__main__" ):
    const = load__constants( inpFile="test/parameter.conf" )
    print( const )
